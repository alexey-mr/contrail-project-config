- job:
    name: base-minimal
    parent: null
    description: |
      A subset of what the 'base' job provides: the absolute minimum considered
      required to run for any one job.
      It doesn't set up cached git repositories, will not set up mirrors,
      doesn't validate the node and does not generate an ARA report.
      These tasks, if required, can be included by the dependant jobs
      themselves on a need basis.
    pre-run: playbooks/base-minimal/pre.yaml
    post-run:
      - playbooks/base-minimal/post-ssh.yaml
      - playbooks/base-minimal/post-logs.yaml
    roles:
      - zuul: Juniper/zuul-jobs
    timeout: 1800
    secrets:
      - site_logs

- job:
    name: base
    parent: null
    description: |
      The base job all other OpenContrail jobs inherit from.

      Everything starts and ends with this base job. It runs pre-playbooks
      which copy job's git repositories prepared by zuul merger to all
      nodes that are part of the nodeset. It also runs post-playbooks
      that upload logs/ to the logserver.
    pre-run: playbooks/base/pre.yaml
    post-run:
      - playbooks/base/post-ssh.yaml
      - playbooks/base/post-logs.yaml
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: progmaticlab/contrail-zuul-jobs
    timeout: 3600
    secrets:
      - site_logs

- job:
    name: contrail-base
    parent: null
    description: |
      A base job that prepares the builder
    pre-run: playbooks/contrail/pre.yaml
    post-run:
      - playbooks/contrail/post.yaml
      - playbooks/base/post-ssh.yaml
      - playbooks/base/post-logs.yaml
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: progmaticlab/contrail-zuul-jobs
    timeout: 3600
    secrets:
      - site_logs

- job:
    name: contrail-src-base
    parent: contrail-base-untrusted
    description: |
      A base job that directly copies source code prepared by zuul to the builder node,
      as opposed to the contrail-vnc-base job that uses Android repo to prepare the source tree.
    pre-run: playbooks/contrail/src-pre.yaml
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: progmaticlab/contrail-zuul-jobs

- job:
    name: contrail-vnc-base
    branches:
      - ^R5\.0$
      - ^contrail_dpdk_17_11_3$
      - ^release-3.9-contrail$
    parent: contrail-base-untrusted
    override-checkout: R5.0
    description: |
      A base job that prepares Contrail VNC sandbox using Android repo,
      as opposed to the contrail-src-base job that copies the sources directly.
    required-projects:
      - Juniper/contrail-analytics
      - Juniper/contrail-ansible-deployer
      - Juniper/contrail-api-client
      - Juniper/contrail-build
      - Juniper/contrail-common
      - Juniper/contrail-container-builder
      - Juniper/contrail-controller
      - Juniper/contrail-deployers-containers
      - Juniper/contrail-fabric-utils
      - name: Juniper/contrail-dpdk
        override-checkout: contrail_dpdk_17_11_3
      - Juniper/contrail-generateDS
      - Juniper/contrail-heat
      - Juniper/contrail-helm-deployer
      - Juniper/contrail-java-api
      - Juniper/contrail-kolla-ansible
      - Juniper/contrail-neutron-plugin
      - Juniper/contrail-nova-vif-driver
      - Juniper/contrail-packages
      - Juniper/contrail-provisioning
      - Juniper/contrail-sandesh
      - Juniper/contrail-specs
      - Juniper/contrail-test
      - Juniper/contrail-third-party
      - Juniper/contrail-tripleo-puppet
      - Juniper/contrail-vcenter-plugin
      - Juniper/contrail-vcenter-manager
      - Juniper/contrail-vcenter-fabric-manager
      - Juniper/contrail-vnc
      - Juniper/contrail-vrouter
      - Juniper/contrail-vrouter-java-api
      - Juniper/contrail-vro-plugin
      - Juniper/contrail-web-controller
      - Juniper/contrail-web-core
      - Juniper/contrail-web-server-manager
      - Juniper/contrail-web-storage
      - Juniper/contrail-webui-third-party
      - Juniper/openshift-ansible
      - Juniper/openstack-helm
      - Juniper/openstack-helm-infra
      - Juniper/vijava
    pre-run: playbooks/contrail/vnc-pre.yaml

- job:
    name: contrail-vnc-base
    branches: ^(?!(R5\.0|contrail_dpdk_17_11_3|release-3\.9-contrail)).*$
    parent: contrail-base-untrusted
    description: |
      A base job that prepares Contrail VNC sandbox using Android repo,
      as opposed to the contrail-src-base job that copies the sources directly.
    required-projects:
      - Juniper/contrail-analytics
      - Juniper/contrail-ansible-deployer
      - Juniper/contrail-api-client
      - Juniper/contrail-build
      - Juniper/contrail-common
      - Juniper/contrail-container-builder
      - Juniper/contrail-controller
      - Juniper/contrail-deployers-containers
      - Juniper/contrail-fabric-utils
      - name: Juniper/contrail-dpdk
        override-checkout: contrail_dpdk_18_05_1
      - Juniper/contrail-generateDS
      - Juniper/contrail-heat
      - Juniper/contrail-helm-deployer
      - Juniper/contrail-java-api
      - Juniper/contrail-kolla-ansible
      - Juniper/contrail-neutron-plugin
      - Juniper/contrail-nova-vif-driver
      - Juniper/contrail-packages
      - Juniper/contrail-provisioning
      - Juniper/contrail-sandesh
      - Juniper/contrail-specs
      - Juniper/contrail-test
      - Juniper/contrail-third-party
      - Juniper/contrail-tripleo-puppet
      - Juniper/contrail-vcenter-plugin
      - Juniper/contrail-vcenter-manager
      - Juniper/contrail-vcenter-fabric-manager
      - Juniper/contrail-vnc
      - Juniper/contrail-vrouter
      - Juniper/contrail-vrouter-java-api
      - Juniper/contrail-vro-plugin
      - Juniper/contrail-web-controller
      - Juniper/contrail-web-core
      - Juniper/contrail-web-server-manager
      - Juniper/contrail-web-storage
      - Juniper/contrail-webui-third-party
      - Juniper/openshift-ansible
      - Juniper/openstack-helm
      - Juniper/openstack-helm-infra
      - Juniper/vijava
    pre-run: playbooks/contrail/vnc-pre.yaml

- job:
    name: build-variables-init
    parent: contrail-base-untrusted
    run: playbooks/contrail/build-variables-init.yaml
    secrets:
      - build_cache_db

#- job:
#    name: contrail-vnc-publish-containers-nightly
#    parent: contrail-src-base
#    description: |
#      A job for publishing Docker containers to DockerHub.
#    required-projects:
#      - Juniper/contrail-publisher
#      - tungsten-infra/containerregistry
#    run: playbooks/docker/publish-nightly.yaml
#    nodeset: worker-centos-7
#    secrets:
#      - docker_registry
#      - dockerhub

# Transition to contrail-base when all jobs are ported
- job:
    name: contrail-base2
    description: |
      A base job that prepares job environment to run contrail
      jobs (e.g. making version information available) as well as any
      post tasks like uploading packages to the repository host, and
      containers to docker registries.
      It copies artifacts dir from workers to executor as a post step.
    pre-run: playbooks/contrail-base2/pre.yaml
    post-run: playbooks/contrail-base2/post.yaml
    roles:
      - zuul: Juniper/zuul-jobs
      - zuul: progmaticlab/contrail-zuul-jobs
    timeout: 3600

- job:
    name: publish-infra-doc
    description: |
      This job is posting infra-doc html.
    parent: build-infra-doc
    required-projects:
      - progmaticlab/contrail-zuul-jobs
      - Juniper/contrail-infra-doc
    post-run: playbooks/publish-infra-doc/post.yaml
    nodeset: worker-centos-7
    secrets:
      - site_logs

- job:
    name: publish-third-party-packages
    parent: build-third-party-rpms-base
    description: |
      Publish build rpms to Nexus repository.
    required-projects:
      - progmaticlab/contrail-zuul-jobs
    post-run: playbooks/publish-third-party-packages/post.yaml
    nodeset: worker-centos-7
